@*
 * Copyright 2017 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@(debug:Boolean, botEmail:String)(implicit request: Request[_])

<html>

<head>
    <style>
        body {
            background: #eee url("https://mockuphone.com/static/images/devices/apple-iphone6plus-gold-portrait.png") no-repeat;
            color: #222;
            font: 1em/1.5 'Helvetica Neue', Helvetica, Arial, sans-serif;
            text-align: center;
        }

        #chatbox {
            text-align: left;
            margin: 2.9rem 13.7rem;
            background: #fff;
            height: 23rem;
            width: 15.8rem;
            border: 0.05rem solid black;
            overflow: auto;
            padding: 1rem;
        }

        #msgform {
            text-align: left;
            margin: 0 auto 2rem;
            background: #fff;
            height: 3rem;
            width: 17.8rem;
            border: 0.05rem solid black;
            overflow: auto;
            padding: 0;
            top: 32.4rem;
            left: 14.2rem;
            position: absolute;
            border-top: 0;
        }

        #usermsg{
            width: 13rem;
            height: 2rem;
            border-radius: 8px;
            margin-left: 6px;
            padding-top: 0;
            padding-left: 10px;
            font-size: large;
            border: 1px solid black;
        }

        #usermsg:focus{
            outline: none;
        }

        #submitmsg{
            cursor: pointer;
            height: 2rem;
            width: 3.7rem;
            background: #35b128;
            border: 1px solid #33842a;
            border-radius: 10px;
            box-shadow: 0 0 4px rgba(0,0,0, .75);
            color: #f3f3f3;
            font-size: 1.1em;
            margin-top: 5px;
        }

        #submitmsg:hover, #submitmsg:focus{
            outline: none;
            background-color: #399630;
            -webkit-box-shadow: 0 0 1px rgba(0,0,0, .75);
            -moz-box-shadow: 0 0 1px rgba(0,0,0, .75);
            box-shadow: 0 0 1px rgba(0,0,0, .75);
        }

        .message {
        background-image: linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
        background-image: -o-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
        background-image: -moz-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
        background-image: -webkit-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
        background-image: -ms-linear-gradient(bottom, rgb(210, 244, 254) 25%, rgb(149, 194, 253) 100%);
        background-image: -webkit-gradient(
        linear,
        left bottom,
        left top,
        color-stop(0.25, rgb(210, 244, 254)),
        color-stop(1, rgb(149, 194, 253))
        );
        border: solid 1px rgba(0, 0, 0, 0.5);
        border-radius: 20px;
        box-shadow: inset 0 5px 5px rgba(255, 255, 255, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2);
        box-sizing: border-box;
        clear: both;
        float: left;
        margin-bottom: 20px;
        padding: 8px 20px;
        position: relative;
        text-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);
        width: auto;
        max-width: 100%;
        word-wrap: break-word;
        }

        .message:before, .message:after {
        border-radius: 20px / 10px;
        content: '';
        display: block;
        position: absolute;
        }

        .message:before {
        border: 10px solid transparent;
        border-bottom-color: rgba(0, 0, 0, 0.5);
        bottom: -1px;
        left: -6px;
        z-index: 0;
        }

        .message:after {
        border: 8px solid transparent;
        border-bottom-color: #d2f4fe;
        bottom: 0px;
        left: -3px;
        }

        .csa {
        background-image: linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
        background-image: -o-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
        background-image: -moz-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
        background-image: -webkit-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
        background-image: -ms-linear-gradient(bottom, rgb(172, 228, 75) 25%, rgb(122, 205, 71) 100%);
        background-image: -webkit-gradient(
        linear,
        left bottom,
        left top,
        color-stop(0.25, rgb(172, 228, 75)),
        color-stop(1, rgb(122, 205, 71))
        );
        float: right;
        }

        .csa:before {
        border-bottom-color: rgba(0, 0, 0, 0.5);
        border-radius: 20px / 10px;
        left: auto;
        right: -6px;
        }

        .csa:after {
        border-bottom-color: #ace44b;
        border-radius: 20px / 10px;
        left: auto;
        right: -3px;
        }
</style>

    <title>Chat - Customer Module</title>
    @*<link type="text/css" rel="stylesheet" href="style.css" />*@
</head>
<body>
<div id="wrapper">

    <div  id="waitDiv" style="display: none;" class="animate-bottom"></div>

    <div id="config" class="container">
        <form id="configform">
            Client Id: <input type="text" name="clientId" id="clientId"><br>
            Room Name: <input type="text" name="roomName" id="roomName"><br>
        </form>

        <button onclick="createroom()">Create Room</button>
    </div>

    <div id="chatdemo" style="display: none;">

        <div id="menu">
            <p id="clientRoomName" class="welcome"><b></b></p>
            <p class="logout"><a id="exit" href="#">Exit Chat</a></p>
            <div style="clear:both"></div>
        </div>

        <div id="chatbox"></div>
        <form name="message" id="msgform" action="">
            <input name="usermsg" type="text" id="usermsg" size="63" />
            <input name="submitmsg" type="submit"  id="submitmsg" value="Send" />
        </form>

        <div>
            <span>Invite CSA to join current chat</span>
            <form>
                CSA email: <input type="text" name="clientId" id="csaEmailAddress"><br>
            </form>
            <button onclick="inviteCSA()">Invite</button>
        </div>
    </div>
</div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script type="text/javascript">


function hide(id) {
   var e = document.getElementById(id);
    e.style.display = 'none';
}

function show(id) {
   var e = document.getElementById(id);
        e.style.display = 'block';
}

var userId = "";
var sparkRoomId = "";

function inviteCSA() {
    var clientId = $("#clientId").val();
    var csaEmail = $("#csaEmailAddress").val();
    if (csaEmail.length == 0) {
        alert('Please enter an email address.');
        return;
    }

show("waitDiv");

    $.getJSON('/async-message-broker/membership?roomId='+sparkRoomId+'&clientId='+clientId+'&email='+csaEmail, function (data) {
        $("#csaEmailAddress").attr("value", "");
        hide("waitDiv");
        alert('CSA has been invited to the chat room ' + $("#roomName").val());
    });
}

function createroom() {
    var clientId = $("#clientId").val();
    var roomName = $("#roomName").val();

show("waitDiv");

    $.getJSON('/async-message-broker/room?clientId='+clientId+'&roomName='+roomName, function (data) {
        console.log(data);
        userId = data.clientId;
        sparkRoomId = data.roomId;

        $("#roomId").text(sparkRoomId);
        $("#clientRoomName").text("Room name: " + $("#roomName").val());

hide("waitDiv");

        hide("config");
        show("chatdemo");
    });
    console.log('executed');
}

function readCSAMessages() {
    $.getJSON('/async-message-broker/sync', function (data) {
    });
}

function retrievemessages() {
    var showData = $('#chatbox');
    $.getJSON('/async-message-broker/roommessages?clientId='+userId+'&roomId='+sparkRoomId, function (data) {
        console.log(data);

        showData.empty();

        var items = data.map(function (item) {
            var classes = item.email === "@botEmail" ? "message" : "message csa";
            var content = '<div class="' + classes + '">' + item.text + '</div>';
            showData.append(content);
        });
    });
}

// jQuery Document
$(document).ready(function(){

});
</script>
</body>

<script>

    // Sending message to server.
	$("#submitmsg").click(function() {
	    var showData = $('#chatbox');
        var clientmsg = $("#usermsg").val();

        $.get("/async-message-broker/message?clientId="+userId+"&roomId="+sparkRoomId+"&message="+clientmsg, function(data, status){
                var content = '<div class="message">' + clientmsg + '</div>';
                showData.append(content);
        });

        setInterval (retrievemessages, 2500);
        setInterval (readCSAMessages, 4000);

		$("#usermsg").attr("value", "");
        retrievemessages();
		return false;
	});

</script>

</html>